System.register(["jimu-core","calcite-components","esri/Graphic"],(function(e,t){var a={},c={},l={};return{setters:[function(e){a.DataSourceManager=e.DataSourceManager,a.React=e.React,a.appActions=e.appActions,a.getAppStore=e.getAppStore},function(e){c.CalciteAction=e.CalciteAction,c.CalciteButton=e.CalciteButton,c.CalciteInput=e.CalciteInput,c.CalciteInputDatePicker=e.CalciteInputDatePicker,c.CalciteInputNumber=e.CalciteInputNumber,c.CalciteInputText=e.CalciteInputText,c.CalciteLabel=e.CalciteLabel,c.CalciteList=e.CalciteList,c.CalciteListItem=e.CalciteListItem,c.CalciteOption=e.CalciteOption,c.CalciteSelect=e.CalciteSelect,c.CalciteTab=e.CalciteTab,c.CalciteTabNav=e.CalciteTabNav,c.CalciteTabTitle=e.CalciteTabTitle,c.CalciteTabs=e.CalciteTabs},function(e){l.default=e.default}],execute:function(){e((()=>{var e={145:e=>{"use strict";e.exports=c},129:e=>{"use strict";e.exports=l},891:e=>{"use strict";e.exports=a}},t={};function r(a){var c=t[a];if(void 0!==c)return c.exports;var l=t[a]={exports:{}};return e[a](l,l.exports,r),l.exports}r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="";var n={};return r.p=window.jimuConfig.baseUrl,(()=>{"use strict";r.r(n),r.d(n,{default:()=>s});var e=r(891),t=r(145);function a({sourceFields:a,cancelUpdate:c,dataRecord:l,selectedFields:r,fieldSchema:n,updateRecord:o,editType:i}){console.log(i);const s=(()=>{const e={};return a.forEach((t=>{t.domain&&"coded-value"===t.domain.type&&(e[t.name]=t.domain.codedValues)})),e})(),u=a.map((e=>e.editable&&e.name)).filter((e=>e)),[d,p]=e.React.useState((e=>{const t=Object.entries(e),a={};return t.forEach((e=>{if("esriFieldTypeDate"===n[e[0]].esriType)if(e[1]){const t=new Date(e[1]).toISOString();a[e[0]]=t.split("T")[0]}else a[e[0]]=null;else a[e[0]]=e[1]})),a})(l)),m=a.filter((e=>e.length>500)).map((e=>e.name)),f=(()=>{const e={};return a.forEach((t=>{e[t.name]=t.length})),e})(),g=()=>{const e=Object.assign({},l);for(const t of r)if("esriFieldTypeDate"===n[t].esriType){const a=Date.parse(d[t]);e[t]=a}else e[t]=d[t];o(e,i)},C=e=>{const t=Object.assign(Object.assign({},d),{[e.target.id]:e.target.value});p(t)};return e.React.createElement("div",{style:{marginTop:"12px"}},"delete"===i&&e.React.createElement("h1",{className:"sub-nav-title"},"Delete this record?"),r.map((a=>{const c=n[a].esriType,l=n[a].alias;let r;return r=u.includes(a)&&"delete"!==i?Object.prototype.hasOwnProperty.call(s,a)?e.React.createElement(t.CalciteSelect,{onCalciteSelectChange:C,label:a,id:a,name:a,value:d[a]},s[a].map((c=>e.React.createElement(t.CalciteOption,{selected:c.code===d[a],value:c.code},c.name)))):"esriFieldTypeString"===c?m.includes(a)?e.React.createElement("textarea",{id:a,maxLength:f[a],onChange:C,value:d[a]}," "):e.React.createElement(t.CalciteInputText,{id:a,maxLength:f[a],onCalciteInputTextInput:C,value:d[a]}):"esriFieldTypeDate"===c?e.React.createElement(t.CalciteInputDatePicker,{id:a,onCalciteInputDatePickerChange:C,value:d[a]}):"esriFieldTypeInteger"===c?e.React.createElement(t.CalciteInputNumber,{id:a,onCalciteInputNumberInput:C,value:d[a]}):e.React.createElement(t.CalciteInput,{onCalciteInputChange:C,value:d[a],id:a}):e.React.createElement(t.CalciteInput,{id:a,"read-only":!0,value:d[a]}),e.React.createElement(t.CalciteLabel,null,l,r)})),e.React.createElement(t.CalciteButton,{width:"half",slot:"footer",appearance:"outline",onClick:c},"Cancel"),"delete"===i?e.React.createElement(t.CalciteButton,{width:"half",kind:"danger",slot:"footer",onClick:g},"Permanently Delete"):e.React.createElement(t.CalciteButton,{width:"half",slot:"footer",onClick:g},"Submit"))}var c=r(129),l=function(e,t,a,c){return new(a||(a=Promise))((function(l,r){function n(e){try{i(c.next(e))}catch(e){r(e)}}function o(e){try{i(c.throw(e))}catch(e){r(e)}}function i(e){var t;e.done?l(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(n,o)}i((c=c.apply(e,t||[])).next())}))};function o(r){const[n,o]=e.React.useState(null),[i,s]=e.React.useState(null),[u,d]=e.React.useState(null),p=`${r.dsProp.foreignKey} = '${r.globalId}'`,m=t=>{r.dataSource.layer.applyEdits(t).then((t=>{!function(){l(this,void 0,void 0,(function*(){const e={where:p,pageSize:1e3},t=yield r.dataSource.query(e);d(t.records)}))}(),r.dataSource.setSourceRecords(r.dataSource.getRecords()),(0,e.getAppStore)().dispatch(e.appActions.widgetStatePropChange(r.widgetId,"changed",p))})).catch((e=>{console.log("error = ",e)}))},f=()=>{o(null)},g=(e,t)=>("esriFieldTypeDate"===e&&t?new Date(t).toLocaleDateString():t)||"No Value";e.React.useEffect((()=>{r.globalId&&(function(){l(this,void 0,void 0,(function*(){const e={where:p,pageSize:1e3},t=yield r.dataSource.query(e);d(t.records)}))}(),f())}),[r,d,p]);const C=r.dataSource.getFetchedSchema().fields;return null===r.globalId?e.React.createElement(t.CalciteList,null,e.React.createElement(t.CalciteListItem,{label:"No Record Selected"})):r.dsProp&&r.dsProp.header&&r.fields&&r.dsProp.foreignKey&&u?e.React.createElement("div",null,n?e.React.createElement(a,{sourceFields:r.dataSource.layer.fields,fieldSchema:C,dataRecord:n,selectedFields:r.fields,updateRecord:(e,t)=>{const a=new c.default({attributes:e});"update"===t?m({updateFeatures:[a]}):"create"===t?m({addFeatures:[a]}):"delete"===t&&m({deleteFeatures:[a]}),f()},cancelUpdate:f,editType:i}):e.React.createElement(t.CalciteList,null,!!r.dsProp.newFeatures&&e.React.createElement(t.CalciteListItem,{label:"Create New Record",onCalciteListItemSelect:()=>(()=>{const e=(()=>{const e={};return r.fields.forEach((t=>{e[t]=null})),e[r.dsProp.foreignKey]=r.globalId,e})();s("create"),o(e)})()}),u.length>0?u.map((a=>{const c=a.getData(),l=g(C[r.dsProp.header].esriType,c[r.dsProp.header]),n=r.dsProp.subHeader?g(C[r.dsProp.subHeader].esriType,c[r.dsProp.subHeader]):null;return e.React.createElement(t.CalciteListItem,{label:l,description:n,onCalciteListItemSelect:()=>(e=>{s("update"),o(e)})(c)},!!r.dsProp.deleteFeatures&&e.React.createElement(t.CalciteAction,{onClick:()=>(e=>{s("delete"),o(e)})(c),slot:"actions-end",text:"delete",icon:"trash"}))})):e.React.createElement(t.CalciteListItem,{label:"No Available Records"}))):e.React.createElement(t.CalciteList,null,e.React.createElement(t.CalciteListItem,{label:"Configure the Data Source"}))}function i({props:a,dss:c,globalId:l}){const r=a.config;return r.parentDataSource&&a.useDataSources&&a.useDataSources.length>0&&Object.prototype.hasOwnProperty.call(r,"dsProps")&&a.useDataSources.map((e=>e.dataSourceId)).every((e=>Object.prototype.hasOwnProperty.call(r.dsProps,e)))?e.React.createElement("div",{className:"",style:{border:"black 1px",width:"100%",height:"100%",backgroundColor:"#ffffff"}},e.React.createElement(t.CalciteTabs,{className:"jimu-widget surface-1",style:{padding:"10px 16px 16px"}},e.React.createElement(t.CalciteTabNav,{className:"",slot:"title-group"},c.map((a=>{return a.id!==r.parentDataSource||a.id===r.parentDataSource&&r.displayParent?e.React.createElement(t.CalciteTabTitle,{className:" tab-title"},("label",c=a.id,(Object.prototype.hasOwnProperty.call(r,"dsProps")&&Object.prototype.hasOwnProperty.call(r.dsProps,c)?r.dsProps[c].label:null)||a.getLabel())):null;var c}))),c.map((c=>{return e.React.createElement(e.React.Fragment,null,(i=c.id,(r.parentDataSource!==i||r.parentDataSource===i&&r.displayParent)&&e.React.createElement(t.CalciteTab,{style:{paddingBlock:"inherit"}},e.React.createElement(o,{globalId:l,widgetId:a.id,fields:(n=c.id,a.useDataSources.filter((e=>e.dataSourceId===n))[0].fields),dataSource:c,dsProp:r.dsProps[c.id],isParent:c.id===r.parentDataSource}))));var n,i})))):e.React.createElement(t.CalciteList,null,e.React.createElement(t.CalciteListItem,{label:"This widget allows you to edit related tables in a feature layer",description:"Configure the data source."}))}function s(t){var a;const c=t.stateProps||{},l=t.config,r=l.dsProps[l.parentDataSource].foreignKey,[n,o]=e.React.useState(null),s=e.DataSourceManager.getInstance(),u=Object.prototype.hasOwnProperty.call(c,"selection")?c.selection:null;console.log(u);const d=u&&u.sourceId===l.parentDataSource&&(e=>{return t=this,a=void 0,o=function*(){console.log(e);const t=n.filter((e=>e.id===l.parentDataSource))[0];return yield t.ready(),t.getSelectedRecords().map((e=>e.getData()[r]))[0]===e},new((c=void 0)||(c=Promise))((function(e,l){function r(e){try{i(o.next(e))}catch(e){l(e)}}function n(e){try{i(o.throw(e))}catch(e){l(e)}}function i(t){var a;t.done?e(t.value):(a=t.value,a instanceof c?a:new c((function(e){e(a)}))).then(r,n)}i((o=o.apply(t,a||[])).next())}));var t,a,c,o})(u.data[r])?u.data[r]:null;return e.React.useEffect((()=>{setTimeout((function(){(()=>{const e=[];try{s.createAllDataSources().then((a=>{var c;null===(c=t.useDataSources)||void 0===c||c.forEach((t=>{const a=s.getDataSource(t.dataSourceId);e.push(a)})),o(e)}))}catch(e){console.log(e)}})()}),1e3)}),[s,t.useDataSources]),(null==n?void 0:n.length)===(null===(a=t.useDataSources)||void 0===a?void 0:a.length)&&e.React.createElement("div",{className:"widget-content esri-widget",style:{border:"1px solid var(--dark)"}},e.React.createElement(i,{props:t,globalId:d,dss:n}))}})(),n})())}}}));